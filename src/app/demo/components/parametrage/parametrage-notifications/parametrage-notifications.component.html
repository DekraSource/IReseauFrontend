

<div class="card">
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
  <p-toolbar>
    <ng-template pTemplate="left">
       <span class="text-xl font-bold">Paramétrage Notifications</span>
    </ng-template>
    <ng-template pTemplate="right">
      <p-button  type="button" icon="pi pi-plus" label="Nouveau" (click)="openDialog()"
        severity="secondary" styleClass="p-button-outlined"></p-button>
    </ng-template>
  </p-toolbar>

  <p-table #dt [value]="parametrageNotifications" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,30,50]"
  [showCurrentPageReport]="true" currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} entrées"
    styleClass="p-datatable-gridlines p-datatable-sm p-datatable-striped p-datatable-hoverable-rows" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="notificationDeclencher.libelle">Notification Déclencher <p-sortIcon
            field="notificationDeclencher.libelle"></p-sortIcon></th>
        <th pSortableColumn="delai">Délai <p-sortIcon field="delai"></p-sortIcon></th>
        <th pSortableColumn="dateCreation">Date Création <p-sortIcon field="dateCreation"></p-sortIcon></th>
        <th style="width: 120px">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-notification>
      <tr>
        <td>{{notification.notificationDeclencher?.libelle}}</td>
        <td>{{notification.delai}}</td>
        <td>
          <p-tag [severity]="success" [value]="notification.dateCreation | date: 'dd/MM/yyyy'"></p-tag>
        </td>
        <td>
          <div class="flex justify-content-end gap-2">
            <button pButton type="button" icon="pi pi-pencil" class="p-button-outlined p-button-sm"
              (click)="edit(notification)" pTooltip="Modifier" tooltipPosition="top"></button>
            <button pButton type="button" icon="pi pi-trash" class="p-button-outlined p-button-danger p-button-sm"
              (click)="delete(notification.id)" pTooltip="Supprimer" tooltipPosition="top"></button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4">Aucune notification paramétrée</td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog [(visible)]="visible" [modal]="true" [dismissableMask]="true" [style]="{width: '80vw'}" [maximizable]="true" [draggable]="false"
    [resizable]="false" [closable]="true">
    <ng-template pTemplate="header">
      <div class="flex align-items-center">
        <i class="pi pi-list mr-2"></i>
        <span class="font-bold text-xl">Formulaire</span>
      </div>
    </ng-template>

    <div class="p-fluid grid">
      <div class="field col-6">
        <label for="delai">Délai</label>
        <p-inputNumber id="delai" [(ngModel)]="model.delai" mode="decimal" 
          [showButtons]="true"></p-inputNumber>
      </div>

      <div class="field col-6">
        <label for="notificationDeclencherId">Déclencher</label>
        <p-dropdown id="notificationDeclencherId" [(ngModel)]="model.notificationDeclencherId"
          [options]="notificationDeclenchers" optionLabel="libelle" optionValue="id" [showClear]="true"
          placeholder="Fait votre choix">
        </p-dropdown>
      </div>

      <div class="field col-12">
        <label>Variables disponibles (cliquer pour copier et insérer)</label>
        <div class="chip-container">
          <div *ngFor="let chip of draggableChips" class="custom-chip" [ngClass]="'chip-' + chip.color"
            (click)="onChipClick(chip.text)">
            {{chip.label}}
            <i class="pi pi-copy ml-2" style="font-size: 0.8rem"></i>
          </div>
        </div>
      </div>
      <div class="field col-12">
        <label for="emailTo">Email To</label>
        <input id="emailTo" type="text" pInputText [(ngModel)]="model.emailTo" />
      </div>

      <div class="field col-12">
        <label for="object">Object</label>
        <input id="object" type="text" pInputText [(ngModel)]="model.object" />
      </div>

      <div class="field col-12" #editorContainer>
        <label for="body">Corps du message</label>
        <p-editor #editor [(ngModel)]="model.body" contenteditable="true" [ngModelOptions]="{ standalone: true }"
          [style]="{'height':'320px'}">
        </p-editor>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="Annuler" (click)="cancel()" class="p-button-text"></button>
      <button pButton type="button" label="Enregistrer" (click)="submit()" class="p-button-primary"></button>
    </ng-template>
  </p-dialog>
</div>